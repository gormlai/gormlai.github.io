<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  
    class="html theme--light"
  
><head>
  <title>
    Gorm
        |
        Metal shading language compiler
      

    

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.92.2" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="Gorm" />
  <meta
    name="description"
    content="Virtual Reality Pioneer
Game Dev Veteran
Doctoral Candidate in Game AI"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="/scss/main.min.1147aa5bacb4bce677a0e264073829caedb82fd18ea07a5f1d80521f539d1c45.css"
      integrity="sha256-EUeqW6y0vOZ3oOJkBzgpyu24L9GOoHpfHYBSH1OdHEU="
      crossorigin="anonymous"
      type="text/css"
    />
  

  
  <link
    rel="stylesheet"
    href="/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css"
    integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

  <link rel="canonical" href="https://gormlai.github.io/blog/msl2glsl/" />

  
  
  
  
  <script
    type="text/javascript"
    src="/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js"
    integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="/js/anatole-theme-switcher.min.4c31f3cf7e8e609c897dba88aecac0e8db1ebb4e5c841d3f9ffb01d463973678.js"
      integrity="sha256-TDHzz36OYJyJfbqIrsrA6Nseu05chB0/n/sB1GOXNng="
      crossorigin="anonymous"
    ></script>
  

  


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Metal shading language compiler"/>
<meta name="twitter:description" content="Background When I first met Johan, and he initially hired me to work on Fugl, before I became a partner on the game, he had the initial version running on iOS using Metal and MSL."/>



  
  <meta property="og:title" content="Metal shading language compiler" />
<meta property="og:description" content="Background When I first met Johan, and he initially hired me to work on Fugl, before I became a partner on the game, he had the initial version running on iOS using Metal and MSL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gormlai.github.io/blog/msl2glsl/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2019-10-12T22:23:29+01:00" />
<meta property="article:modified_time" content="2019-10-12T22:23:29+01:00" /><meta property="og:site_name" content="Gorm Lai" />




  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "blog",
        "name": "Metal shading language compiler",
        "headline": "Metal shading language compiler",
        "alternativeHeadline": "",
        "description": "
      
        Background When I first met Johan, and he initially hired me to work on Fugl, before I became a partner on the game, he had the initial version running on iOS using Metal and MSL.


      


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/gormlai.github.io\/blog\/msl2glsl\/"
        },
        "author" : {
            "@type": "Person",
            "name": "Gorm"
        },
        "creator" : {
            "@type": "Person",
            "name": "Gorm"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "Gorm"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "Gorm"
        },
        "copyrightYear" : "2019",
        "dateCreated": "2019-10-12T22:23:29.00Z",
        "datePublished": "2019-10-12T22:23:29.00Z",
        "dateModified": "2019-10-12T22:23:29.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "Gorm",
            "url": "https://gormlai.github.io",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/gormlai.github.iofavicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
      ]

    ,
        "url" : "https:\/\/gormlai.github.io\/blog\/msl2glsl\/",
        "wordCount" : "663",
        "genre" : [ 
      
      "computer graphics"

    ],
        "keywords" : [ 
      
      "glsl"

    
      
        ,

      
      "msl"

    
      
        ,

      
      "bison"

    
      
        ,

      
      "flex"

    
      
        ,

      
      "metal"

    
      
        ,

      
      "opengl"

    
      
        ,

      
      "computer graphics"

    
      
        ,

      
      "gpu"

    ]
    }
  </script>


</head>
<body class="body">
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"
        
      ><div
  class="sidebar
    animated fadeInDown
  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="/img/main/profile_pic.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="/">Gorm Lai</a>
        </div>
      
      <div class="sidebar__introduction-description">
        <p>Virtual Reality Pioneer<br />Game Dev Veteran<br />Doctoral Candidate in Game AI</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://www.linkedin.com/in/gormlai/"
            target="_blank"
            rel="noopener me"
            aria-label="Linkedin"
            title="Linkedin"
          >
            <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/gormlai/"
            target="_blank"
            rel="noopener me"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.instagram.com/gormlai"
            target="_blank"
            rel="noopener me"
            aria-label="instagram"
            title="instagram"
          >
            <i class="fab fa-instagram fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
        <li class="sidebar__list-item">
          <a
            href="https://www.twitter.com/gormlai"
            target="_blank"
            rel="noopener me"
            aria-label="twitter"
            title="twitter"
          >
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>
      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Gorm
        2023
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></div>
</aside>
      <main
        
          class="wrapper__main"
        
      >
        <header class="header"><div
  class="
    animated fadeInDown
  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/"
              
              title=""
              >Home</a
            >
          </li>
        

      
        
        

          <li class="nav__list-item">
            <div class="optionswitch">
              <input class="optionswitch__picker" type="checkbox" id="1" hidden />

              
              
                

              
                

              


              <label class="optionswitch__label" for="1"
                >Portfolio <i class="fa fa-angle-down" aria-hidden="true"></i
              ></label>

              <div class="optionswitch__triangle"></div>
              <ul class="optionswitch__list">
                
                  <li class="optionswitch__list-item">
                    
                    <a
                      href="/academic/"
                      
                      title=""
                      >Academic</a
                    >
                  </li>
                
                  <li class="optionswitch__list-item">
                    
                    <a
                      href="/games/"
                      
                      title=""
                      >Games</a
                    >
                  </li>
                
              </ul>
            </div>
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/blog/"
              
              title=""
              >Blog</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/about/"
              
              title=""
              >About</a
            >
          </li>
        

      
        
        
          <li class="nav__list-item">
            
            <a
              
              href="/code/"
              
              title=""
              >Notes</a
            >
          </li>
        

      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>
      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown
    "
  >
    
    <div class="post__content">
      <h1>Metal Shading Language Compiler</h1>
      <p><img src="/img/msl2glsl/Fugl.png" alt="image"></p>
<h4 id="background">Background</h4>
<p>When I first met <a href="twitter.com/melodive">Johan</a>, and he initially hired me to work on <a href="https://fuglgame.com/">Fugl</a>, before I became a partner on the game, he had the initial version running on iOS using Metal and MSL. I did the initial port to OpenGL, and made the game run first on Windows and then in VR with Oculus. Later on Johan continued the work on Metal, as it was quite performant, had a more modern programming interface than OpenGL, and is less complicated to setup for error handling and debugging. Naively, I said, <em>&ldquo;Ok, don&rsquo;t worry, I&rsquo;ll port it over to Windows&rdquo;</em>. I had already done the initial port of Fugl from iOS to Desktop (Windows / Mac) and Oculus VR, so with typical programmer hybris I jumped at the challenge. However, the shaders and the code were a lot more complicated at this point, than the first time around. It took me quite a while to do this port to OpenGL, and as Johan continued to work on the Mac, keeping track of the changes became quite time consuming. So, I did what any sensible programmer would do, I tried to automate the task.</p>
<h4 id="previous-work">Previous Work</h4>
<p>There is a lot of tools already that can convert between shader languages, such as <a href="https://github.com/KhronosGroup/SPIRV-Cross">Khronos' SPIRV-Cross</a>. However, while there are lot of projects that can convert to Metal and msl, I havent' been able to find one that allows conversion from msl.</p>
<h4 id="technical-details">Technical Details</h4>
<p>Msl2glsl has been built using all the methods I remember from my compiler course at uni 20 years ago. Of course, it turns out I had forgotten most of it, but it was interesting relearning it. The compiler currently only builds on Windows and Linux, and requires Flex and Bison. On Windows, it currently requires WinflexBison and Visual Studio. I am using Meson as my preferred build system on Linux.</p>
<p>Like many automatic code generators, Msl2glsl does produce code that is overly verbose, and as such the code generated is not suitably for production. Given enough time, it is my belief that a human will nearly always be able to produce faster code than a machine, by hand-optimising. However, for Fugl I use a 4 step approach:</p>
<ol>
<li><strong>Convert MSL to GLSL</strong>. Run Msl2glsl to extract glsl shaders from a msl shader file</li>
<li><strong>Convert GLSL to SPIRV</strong>. Run glslangValidator to convert glsl to spirv</li>
<li><strong>Optimise SPIRV Code</strong>. Run spirv-opt on each shader spirv file</li>
<li><strong>Convert SPIRV to GLSL</strong>. Run spirv-cross to convert spirv files backto glsl</li>
</ol>
<p>These 4 steps are packaged into 2 different python scripts, both of which can be found <a href="https://github.com/gormlai/dev-scripts">in a different github repo here.</a>:</p>
<ol>
<li>The first script is just a little python wrapper msl2glsl.exe that takes msl shader file as input and copies the extracted glsl files to an output directory.</li>
<li>The second script is conceptually independent from msl2glsl and simply runs step 2-4 above, by converting glsl to spirv, optimising it and converting it back again.</li>
</ol>
<h4 id="what-the-compiler-doesnt-do">What the compiler doesn&rsquo;t do</h4>
<p>The compiler doesn&rsquo;t generate any of the cpu side code, it only helps with generating shaders. On the cpu side, the user still needs to write a fully fledged OpenGL renderer; loading models, generate VAOs, bind textures, compile shaders, upload uniform buffers, and so.</p>
<h4 id="future-work">Future Work</h4>
<p>While, I suspect for my part, the lifetime of Msl2glsl will closely linked with that of Fugl, we live in a time where products need to be constantly updated, or they will eventually dissappear into the ether of the internet. As such, I suspect Msl2glsl will kept up-to-date for quite a while. A full list of future improvements can be found on the repository, though the primary limitation at the moment, is that the compiler really only supports a c-like subset of MSL, plus the templated samplers, textures, etc. The lexer file should really be replaced with one based on c++14, which is what Msl is officially based on.</p>
<h4 id="repo">Repo</h4>
<p><a href="https://github.com/gormlai/msl2glsl">The code for the msl2glsl compiler can be found here on Github.</a></p>
</div>
    <div class="post__footer">
      
        <span><a class="category" href="/categories/computer-graphics/">computer graphics</a></span>


      

      
        <span><a class="tag" href="/tags/glsl/">glsl</a><a class="tag" href="/tags/msl/">msl</a><a class="tag" href="/tags/bison/">bison</a><a class="tag" href="/tags/flex/">flex</a><a class="tag" href="/tags/metal/">metal</a><a class="tag" href="/tags/opengl/">opengl</a><a class="tag" href="/tags/computer-graphics/">computer graphics</a><a class="tag" href="/tags/gpu/">gpu</a></span>


      
    </div>

    
  </div>

      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        Gorm
        2023
      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script></body>
</html>
